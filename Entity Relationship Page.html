<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MicroSiteKit ‚Äì Entity Relationship Page</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Custom Styles -->
  <link href="Assets/css/style.css" rel="stylesheet" />

  <!-- Mermaid Setup -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: false });
    window.mermaid = mermaid;
  </script>
</head>

<body class="glass">
  <!-- Injected Partials -->
  <div id="shared-header"></div>
  <div id="main-nav"></div>
  <div id="sidebar-nav"></div>

  <!-- Page-Specific Content -->
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb" id="breadcrumb"></ol>
    </nav>
    <div class="row">
      <div class="col-md-4 gradient-col d-flex align-items-center justify-content-center">
        <h3 class="gradient-text">Entity Relationship Page</h3>
      </div>
      <div class="col-md-8">
        <div class="page-intro text-center py-4 px-3">
          <p>This example shows how to use Mermaid syntax to create an entity relationship (ER) diagram
            directly in your
            microsite.
            It‚Äôs editable, theme-safe, and perfect for visualising data models, contributor records, or
            system schemas.
          </p>

          <ul>
            <li>üß† Mermaid syntax lives inside the site‚Äîno external rendering needed</li>
            <li>üé® Theme-safe and layout-friendly‚Äîuses Bootstrap spacing</li>
            <li>üß© Modular and editable‚Äîgreat for onboarding, data mapping, and system design</li>
            <li>üìã Includes copy-to-clipboard button for easy reuse</li>
          </ul>
        </div>
      </div>

      <!-- Page full width content -->
      <div class="row mt-4">
        <div class="col-md">
          <h5 class="mt-4 mb-2">üìä Entity Relationship Diagram Example</h5>
          <p>This Mermaid block renders an ER diagram showing how contributors, roles, and teams relate. You
            can
            customise the entities, fields, and relationships to suit your own data model.</p>

          <!-- Mermaid Diagram Block -->
          <pre class="mermaid snippet">
erDiagram
  CONTRIBUTORS ||--o{ ROLES : has
  CONTRIBUTORS {
    string id
    string name
    string email
  }
  ROLES {
    string id
    string title
    string description
  }
  TEAMS ||--|{ CONTRIBUTORS : includes
  TEAMS {
    string id
    string name
    string mascot
  }
        </pre>

          <!-- Customisation Tips -->
          <div class="mt-4">
            <h6>üõ†Ô∏è How to Customise</h6>
            <ul>
              <li><strong>Change entity names:</strong> Replace <code>CONTRIBUTORS</code>,
                <code>ROLES</code>, etc. with
                your own data tables or objects
              </li>
              <li><strong>Update fields:</strong> Add or remove field definitions inside each entity block
              </li>
              <li><strong>Define relationships:</strong> Use <code>||--o{</code>, <code>|o--o|</code>,
                etc. to show
                cardinality</li>
              <li><strong>Style it:</strong> Mermaid supports themes and configuration via
                <code>mermaid.initialize()</code>
              </li>
            </ul>

            <pre><code class="snippet language-html">
&lt;div class=&quot;mermaid snippet&quot;&gt;
erDiagram
  CONTRIBUTORS ||--o{ ROLES : has
  CONTRIBUTORS {
    string id
    string name
    string email
  }
  ROLES {
    string id
    string title
    string description
  }
  TEAMS ||--|{ CONTRIBUTORS : includes
  TEAMS {
    string id
    string name
    string mascot
  }
&lt;/div&gt;
</code></pre>

            <!-- Copy Button -->
            <button class="btn btn-primary w-100 mb-2" onclick="copyVisibleSnippet()">Copy</button>
          </div>
        </div>
        <div class="row mt-4">
          <div class="col-md border border-primary rounded p-3">
            <section class="playground mt-5">
              <h3>üß≠ ER Diagram Playground</h3>

              <h5>Entities</h5>
              <div id="entitiesForm"></div>
              <button type="button" id="addEntityBtn" class="btn btn-success btn-sm mb-3">+ Add
                Entity</button>

              <h5>Relationships</h5>
              <div id="relationsForm"></div>
              <button type="button" id="addRelationBtn" class="btn btn-success btn-sm mb-3">+ Add
                Relationship</button>
              <br>
              <div class="dohicky-grid">
                <div class="dohicky-item"><button type="button" id="generateBtn" class="btn btn-primary w-100">Generate
                    Code</button></div>
                <div class="dohicky-item"><button type="button" class="btn btn-primary w-100"
                    onclick="copyCode()">Copy</button></div>
                <div class="dohicky-item"><button type="button" class="btn btn-primary w-100"
                    onclick="exportConfig()">üíæ Save Settings</button></div>
                <div class="dohicky-item"> <input type="file" id="configFile" accept=".txt" style="display:none" />
                  <button type="button" class="btn btn-primary w-100"
                    onclick="document.getElementById('configFile').click()">üìÇ Load Settings</button>
                </div>
              </div>

              <div class="row mt-4">
                <div class="col-md-6 border border-primary rounded p-3">
                  <h5>Generated Code</h5>
                  <pre><code id="output"></code></pre>

                </div>
                <div class="col-md-6 border border-primary rounded p-3">
                  <h5>Live Preview</h5>
                  <div id="previewArea"></div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div id="shared-footer"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <!-- Custom JS -->
    <script src="Assets/js/script.js"></script>
    <script src="Assets/js/templates.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const entitiesForm = document.getElementById("entitiesForm");
        const relationsForm = document.getElementById("relationsForm");

        function createEntityRow(defaults = { name: "", attrs: ["string id"] }) {
          const wrapper = document.createElement("div");
          wrapper.className = "entity-row border rounded p-2 mb-2";

          wrapper.innerHTML = `
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Entity name</label>
            <input type="text" class="form-control" name="name" value="${defaults.name}">
          </div>
          <div class="col-md-9">
            <label class="form-label">Attributes (one per line, e.g. "string id")</label>
            <textarea class="form-control" name="attrs" rows="4">${(defaults.attrs || []).join("\n")}</textarea>
          </div>
          <div class="col-12 mt-2">
            <button type="button" class="btn btn-sm btn-danger removeEntityBtn">Remove Entity</button>
          </div>
        </div>
      `;
          entitiesForm.appendChild(wrapper);
        }

        function createRelationRow(defaults = { left: "", cardinality: "||--o{", right: "", label: "has" }) {
          const wrapper = document.createElement("div");
          wrapper.className = "relation-row border rounded p-2 mb-2";

          wrapper.innerHTML = `
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Left entity</label>
            <input type="text" class="form-control" name="left" value="${defaults.left}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Cardinality</label>
            <select class="form-select" name="cardinality">
              <option value="||--||" ${defaults.cardinality === "||--||" ? "selected" : ""}>one-to-one (||--||)</option>
              <option value="||--o{" ${defaults.cardinality === "||--o{" ? "selected" : ""}>one-to-many (||--o{)</option>
              <option value="}|--||" ${defaults.cardinality === "}|--||" ? "selected" : ""}>many-to-one (}|--||)</option>
              <option value="}|--o{" ${defaults.cardinality === "}|--o{" ? "selected" : ""}>many-to-many (}|--o{)</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Right entity</label>
            <input type="text" class="form-control" name="right" value="${defaults.right}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Label</label>
            <input type="text" class="form-control" name="label" value="${defaults.label}">
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button type="button" class="btn btn-sm btn-danger removeRelationBtn">Remove</button>
          </div>
        </div>
      `;
          relationsForm.appendChild(wrapper);
        }

        // Seed with your example
        createEntityRow({ name: "CONTRIBUTORS", attrs: ["string id", "string name", "string email"] });
        createEntityRow({ name: "ROLES", attrs: ["string id", "string title", "string description"] });
        createEntityRow({ name: "TEAMS", attrs: ["string id", "string name", "string mascot"] });

        createRelationRow({ left: "CONTRIBUTORS", cardinality: "||--o{", right: "ROLES", label: "has" });
        createRelationRow({ left: "TEAMS", cardinality: "||--|{", right: "CONTRIBUTORS", label: "includes" });

        // Add buttons
        document.getElementById("addEntityBtn").onclick = () => createEntityRow();
        document.getElementById("addRelationBtn").onclick = () => createRelationRow();

        // Remove handlers
        document.body.addEventListener("click", e => {
          if (e.target.classList.contains("removeEntityBtn")) {
            e.target.closest(".entity-row").remove();
          }
          if (e.target.classList.contains("removeRelationBtn")) {
            e.target.closest(".relation-row").remove();
          }
        });

        // Generate
        document.getElementById("generateBtn").onclick = () => {
          const entities = [...entitiesForm.querySelectorAll(".entity-row")].map(r => ({
            name: r.querySelector('[name="name"]').value.trim(),
            attrs: r.querySelector('[name="attrs"]').value.split("\n")
          })).filter(e => e.name);

          const relations = [...relationsForm.querySelectorAll(".relation-row")].map(r => ({
            left: r.querySelector('[name="left"]').value.trim(),
            cardinality: r.querySelector('[name="cardinality"]').value,
            right: r.querySelector('[name="right"]').value.trim(),
            label: r.querySelector('[name="label"]').value.trim()
          })).filter(rel => rel.left && rel.right);

          const code = templates.erDiagram({ entities, relations });
          document.getElementById("output").textContent = code.trim();
          document.getElementById("previewArea").innerHTML = code;

          if (window.mermaid) {
            mermaid.init(undefined, document.querySelectorAll(".mermaid"));
          }
        };
      });

      function sanitizeSmartCharacters(str) {
        return str
          .replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g, "'") // single quotes
          .replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g, '"') // double quotes
          .replace(/[\u2013]/g, '-') // en dash
          .replace(/[\u2014]/g, '--') // em dash
          .replace(/\u00A0/g, ' ') // non-breaking space
          .replace(/\u2026/g, '...') // ellipsis
          .replace(/\u200B/g, '') // zero-width space
          .replace(/\uFEFF/g, ''); // BOM
      }

      function copyCode() {
        const rawText = document.getElementById("output").textContent;
        const cleanText = sanitizeSmartCharacters(rawText);
        navigator.clipboard.writeText(cleanText);
        alert("Code copied (smart characters cleaned)!");
      }
    </script>
</body>

</html>