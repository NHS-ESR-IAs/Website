<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MicroSiteKit ‚Äì Flu Campaign</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Custom Styles -->
    <link href="Assets/css/style.css" rel="stylesheet" />

    <!-- Mermaid Setup -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script type="module">
        import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
        mermaid.initialize({ startOnLoad: false });
        window.mermaid = mermaid;
    </script>
</head>

<body class="glass">
    <!-- Injected Partials -->
    <div id="shared-header"></div>
    <div id="main-nav"></div>
    <div id="sidebar-nav"></div>

    <!-- Page-Specific Content -->
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb" id="breadcrumb"></ol>
        </nav>
        <div class="row">
            <div class="col-md-4 gradient-col d-flex align-items-center justify-content-center">
                <h3 class="gradient-text">Flu Campaign</h3>
            </div>
            <div class="col-md-8">
                <div class="page-intro text-center py-4 px-3">
                    <!-- Replace this block with your page-specific content -->
                    <section class="intro">
                        <h1>Flu Campaign Portlet Template ü©∫‚ú®</h1>
                        <p>
                            This page contains a ready‚Äëto‚Äëuse template for building a seasonal flu campaign portlet.
                            The code is designed to be <strong>self‚Äëcontained</strong>: copy it as‚Äëis into ESR, or paste
                            it into a sandbox like
                            <a href="https://codepen.io/" target="_blank" rel="noopener">CodePen</a> to see the
                            countdown, pie chart, and bar chart come to life.
                        </p>
                        <p>
                            The template is structured for clarity and reuse:
                        </p>
                        <ul>
                            <li>A central configuration object makes it easy to update dates, percentages, and colours.
                            </li>
                            <li>Countdown, pie, and bar chart logic are wrapped in a self‚Äëexecuting function, so
                                everything runs cleanly each time.</li>
                            <li>All markup, styles, and scripts are bundled together for a simple copy‚Äëand‚Äëpaste
                                workflow.</li>
                        </ul>
                        <p class="note">
                            ‚ö†Ô∏è Note: The ‚Äúlive preview‚Äù panel on this page won‚Äôt execute the scripts.
                            To test the interactive features, please use ESR or an external playground.
                        </p>
                    </section>

                    <section class="usage">
                        <h2>How to Use This Template</h2>
                        <ol>
                            <li><strong>Copy</strong> the full code block below.</li>
                            <li><strong>Paste</strong> it into ESR or a sandbox like CodePen.</li>
                            <li><strong>Preview</strong> the portlet to see the countdown, pie chart, and bar chart
                                animate.</li>
                            <li><strong>Tweak</strong> the configuration values (dates, percentages, colours, labels) to
                                match your campaign.</li>
                            <li><strong>Deploy</strong> the final version into ESR once you‚Äôre happy with the preview.
                            </li>
                        </ol>
                    </section>

                </div>
            </div>
        </div>

        <!-- Page full width content -->

        <div class="row mt-4">
            <div class="col-md border border-primary rounded p-3">
                <section class="playground mt-5">
                    <h3>üíâ Flu Campaign Playground</h3>

                    <div class="mb-2">
                        <label class="form-label">Campaign Title</label>
                        <input type="text" id="campaignTitle" class="form-control" value="Vaccination 2025/26">
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Intro Text</label>
                        <textarea id="introText" class="form-control"
                            rows="2">The 2025/26 Flu Season is upon us‚Ä¶</textarea>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Start Date</label>
                        <input type="text" id="startDate" class="form-control" value="09 September 2025">
                    </div>

                    <div class="mb-2">
                        <label class="form-label">End Date</label>
                        <input type="text" id="endDate" class="form-control" value="28 February 2026">
                    </div>

                    <!-- Info Link -->
                    <div class="mb-2">
                        <label class="form-label">Info Link Text</label>
                        <input type="text" id="infoLinkText" class="form-control" value="More Information">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Info Link URL</label>
                        <input type="text" id="infoLink" class="form-control"
                            value="https://www.nhs.uk/conditions/flu/">
                    </div>
                    <h5 class="mt-3">Countdown Units</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="toggleDays" checked>
                        <label class="form-check-label" for="toggleDays">Show Days</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="toggleHours" checked>
                        <label class="form-check-label" for="toggleHours">Show Hours</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="toggleMinutes" checked>
                        <label class="form-check-label" for="toggleMinutes">Show Minutes</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="toggleSeconds" checked>
                        <label class="form-check-label" for="toggleSeconds">Show Seconds</label>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Countdown Target (ISO)</label>
                        <input type="text" id="countdownDate" class="form-control" value="2026-01-31T17:00">
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Pie %</label>
                        <input type="number" id="piePercentage" class="form-control" value="89.13">
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Pie Colour</label>
                        <input type="color" id="pieColor" class="form-control form-control-color" value="#50C878">

                    </div>

                    <!-- Booking Link -->
                    <div class="mb-2">
                        <label class="form-label">Booking Link Text</label>
                        <input type="text" id="bookingLinkText" class="form-control" value="Book Now">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Booking Link URL</label>
                        <input type="text" id="bookingLink" class="form-control" value="https://example.com/">
                    </div>

                    <h5 class="mt-3">Bar Chart Groups</h5>
                    <div id="barChartForm"></div>
                    <button type="button" id="addBarBtn" class="btn btn-sm btn-success mb-3">+ Add
                        Group</button>

                    <div class="mb-3">
                        <div class="dohicky-grid">
                            <div class="dohicky-item"><button type="button" id="generateBtn"
                                    class="btn btn-primary w-100">Generate Code</button></div>
                            <div class="dohicky-item"><button type="button" class="btn btn-primary w-100"
                                    onclick="copyCode()">Copy</button></div>
                            <div class="dohicky-item"><button type="button" class="btn btn-primary w-100"
                                    onclick="exportConfig()">üíæ Save Settings</button></div>
                            <div class="dohicky-item"> <input type="file" id="configFile" accept=".txt"
                                    style="display:none" /> <button type="button" class="btn btn-primary w-100"
                                    onclick="document.getElementById('configFile').click()">üìÇ Load Settings</button>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6 border border-primary rounded p-3">
                            <h5>Generated Code</h5>
                            <pre><code id="output"></code></pre>

                        </div>
                        <div class="col-md-6 border border-primary rounded p-3">
                            <h5>Live Preview</h5>
                            <div id="previewArea"></div>
                        </div>
                    </div>

                </section>
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>

    <!-- Footer -->
    <div id="shared-footer"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <!-- Custom JS -->
    <script src="Assets/js/script.js"></script>
    <script src="Assets/js/templates.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const barChartForm = document.getElementById("barChartForm");

            // --- Bar chart group builder ---
            function addBarGroup(defaults = { label: "", value: "", color: "#005EB8", delay: "0s" }) {
                const div = document.createElement("div");
                div.className = "border rounded p-2 mb-3";

                div.innerHTML = `
            <h6 class="mb-2">Bar Chart Group</h6>
            <div class="row g-2 mb-2">
                <div class="col-md-7">
                    <label class="form-label">Label</label>
                    <input type="text" class="form-control label" placeholder="Label" value="${defaults.label}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Value (%)</label>
                    <input type="number" class="form-control value" placeholder="%" value="${defaults.value}">
                </div>
                <div class="col-md-1">
                    <label class="form-label">Colour</label>
                    <input type="color" class="form-control form-control-color bar-color" value="${defaults.color}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Delay</label>
                    <input type="text" class="form-control delay" placeholder="0s" value="${defaults.delay}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-sm btn-danger removeBtn">Remove</button>
                </div>
            </div>
        `;
                div.querySelector(".removeBtn").onclick = () => div.remove();
                barChartForm.appendChild(div);
            }

            // Seed with rainbow examples
            addBarGroup({ label: "Emergency & Urgent Care", value: 92.4, color: "#FF0000", delay: "0s" });
            addBarGroup({ label: "Surgical Services", value: 78.9, color: "#FF7F00", delay: "0.1s" });
            addBarGroup({ label: "Medical Specialties", value: 81.2, color: "#FFFF00", delay: "0.2s" });
            addBarGroup({ label: "Maternity & Neonatal", value: 87.6, color: "#00FF00", delay: "0.3s" });
            addBarGroup({ label: "Children & Young People", value: 74.3, color: "#00FFFF", delay: "0.4s" });
            addBarGroup({ label: "Diagnostics & Imaging", value: 89.1, color: "#0000FF", delay: "0.5s" });
            addBarGroup({ label: "Community & Mental Health", value: 83.7, color: "#8B00FF", delay: "0.6s" });
            addBarGroup({ label: "Corporate & Support Services", value: 76.5, color: "#FF1493", delay: "0.7s" });

            document.getElementById("addBarBtn").onclick = () => addBarGroup();

            // --- Generate button ---
            document.getElementById("generateBtn").onclick = () => {
                const barChart = [...document.querySelectorAll("#barChartForm .border")].map(div => ({
                    label: div.querySelector(".label")?.value || "",
                    value: div.querySelector(".value")?.value || "",
                    color: div.querySelector(".bar-color")?.value || "",
                    delay: div.querySelector(".delay")?.value || ""
                }));

                const values = {
                    campaignTitle: document.getElementById("campaignTitle").value,
                    introText: document.getElementById("introText").value,
                    startDate: document.getElementById("startDate").value,
                    endDate: document.getElementById("endDate").value,
                    infoLinkText: document.getElementById("infoLinkText").value,
                    infoLink: document.getElementById("infoLink").value,
                    countdownDate: document.getElementById("countdownDate").value,
                    piePercentage: document.getElementById("piePercentage").value,
                    pieColor: document.getElementById("pieColor").value,
                    bookingLinkText: document.getElementById("bookingLinkText").value,
                    bookingLink: document.getElementById("bookingLink").value,
                    barChart,
                    uid: Date.now()
                };

                const code = templates.fluPortlet(values);
                document.getElementById("output").textContent = code;
                document.getElementById("previewArea").innerHTML = code;

                // Build config from checkboxes
                const countdownConfig = {
                    showDays: document.getElementById("toggleDays").checked,
                    showHours: document.getElementById("toggleHours").checked,
                    showMinutes: document.getElementById("toggleMinutes").checked,
                    showSeconds: document.getElementById("toggleSeconds").checked
                };

                // Render countdown separately
                const targetDate = new Date(values.countdownDate);
                renderCountdown(targetDate, countdownConfig, "countdownPreview");
            };
        });

        // --- Countdown functions ---
        function calculateCountdown(targetDate, config) {
            const now = new Date();
            let diff = Math.max(0, targetDate - now);
            let totalSeconds = Math.floor(diff / 1000);

            let days = Math.floor(totalSeconds / (3600 * 24));
            let hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
            let minutes = Math.floor((totalSeconds % 3600) / 60);
            let seconds = totalSeconds % 60;

            if (!config.showDays) { hours += days * 24; days = 0; }
            if (!config.showHours) { minutes += hours * 60; hours = 0; }
            if (!config.showMinutes) { seconds += minutes * 60; minutes = 0; }

            return { days, hours, minutes, seconds };
        }

        function renderCountdown(targetDate, config) {
            const tiles = document.querySelector("#tiles");

            function update() {
                const { days, hours, minutes, seconds } = calculateCountdown(targetDate, config);

                let html = "";

                if (config.showDays) {
                    html += `<div class="tile"><span>${days}</span><div class="label">Days</div></div>`;
                }
                if (config.showHours) {
                    html += `<div class="tile"><span>${hours}</span><div class="label">Hours</div></div>`;
                }
                if (config.showMinutes) {
                    html += `<div class="tile"><span>${minutes}</span><div class="label">Mins</div></div>`;
                }
                if (config.showSeconds) {
                    html += `<div class="tile"><span>${seconds}</span><div class="label">Secs</div></div>`;
                }

                tiles.innerHTML = html;
            }

            update();
            setInterval(update, 1000);
        }

        // --- Utility functions ---
        function sanitizeSmartCharacters(str) {
            return str
                .replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g, "'")
                .replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g, '"')
                .replace(/[\u2013]/g, '-')
                .replace(/[\u2014]/g, '--')
                .replace(/\u00A0/g, ' ')
                .replace(/\u2026/g, '...')
                .replace(/\u200B/g, '')
                .replace(/\uFEFF/g, '');
        }

        function copyCode() {
            const rawHtml = document.getElementById("previewArea").innerHTML;
            const cleanHtml = sanitizeSmartCharacters(rawHtml);
            navigator.clipboard.writeText(cleanHtml).then(() => {
                alert("Rendered code copied (smart characters cleaned)!");
            });
        }

        document.getElementById("pieColor").addEventListener("input", (e) => {
            document.getElementById("pieColorPreview").style.backgroundColor = e.target.value;
        });
    </script>
</body>

</html>